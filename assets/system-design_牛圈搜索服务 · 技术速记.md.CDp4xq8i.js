import{_ as t,C as l,c as e,o as n,j as i,G as h,ai as r,a as p}from"./chunks/framework.6CbiclxB.js";const b=JSON.parse('{"title":"牛圈搜索服务 · 技术速记","description":"","frontmatter":{"title":"牛圈搜索服务 · 技术速记"},"headers":[],"relativePath":"system-design/牛圈搜索服务 · 技术速记.md","filePath":"system-design/牛圈搜索服务 · 技术速记.md","lastUpdated":1768136749000}'),k={name:"system-design/牛圈搜索服务 · 技术速记.md"};function d(o,s,E,g,c,u){const a=l("ArticleMetadata");return n(),e("div",null,[s[0]||(s[0]=i("h1",{id:"牛圈搜索服务-·-技术速记",tabindex:"-1"},[p("牛圈搜索服务 · 技术速记 "),i("a",{class:"header-anchor",href:"#牛圈搜索服务-·-技术速记","aria-label":'Permalink to "牛圈搜索服务 · 技术速记"'},"​")],-1)),h(a),s[1]||(s[1]=r(`<p><strong>定位</strong><br> 用于快速记录牛圈搜索服务涉及的核心中间件、机制与工程实践。<br> 偏向事实归档与速记，不做概念科普。</p><h2 id="一、apache-shardingsphere-使用背景" tabindex="-1">一、Apache ShardingSphere（使用背景） <a class="header-anchor" href="#一、apache-shardingsphere-使用背景" aria-label="Permalink to &quot;一、Apache ShardingSphere（使用背景）&quot;">​</a></h2><ul><li><strong>核心解决</strong>：分布式数据库下的数据分片、路由、读写分离</li><li><strong>现有依赖</strong>： <ul><li>spring-boot-starter-jdbc</li><li>mybatis-plus-boot-starter</li></ul></li><li><strong>所处位置</strong>：位于 JDBC 层之上、ORM 之下，对业务代码完全透明</li></ul><h2 id="二、spring-属性别名机制" tabindex="-1">二、Spring 属性别名机制 <a class="header-anchor" href="#二、spring-属性别名机制" aria-label="Permalink to &quot;二、Spring 属性别名机制&quot;">​</a></h2><h3 id="_2-1-aliasfor" tabindex="-1">2.1 @AliasFor <a class="header-anchor" href="#_2-1-aliasfor" aria-label="Permalink to &quot;2.1 @AliasFor&quot;">​</a></h3><ul><li>包路径：<code>org.springframework.core.annotation</code></li><li>作用：声明两个注解属性语义完全等价</li><li>重要特性：<strong>双向别名</strong>（设置任一属性均生效）</li></ul><h2 id="三、binlog-机制-构建同步能力" tabindex="-1">三、Binlog 机制（构建同步能力） <a class="header-anchor" href="#三、binlog-机制-构建同步能力" aria-label="Permalink to &quot;三、Binlog 机制（构建同步能力）&quot;">​</a></h2><ul><li><strong>主要用途</strong>：数据变更捕获（CDC）</li><li><strong>关注操作</strong>：仅 INSERT / UPDATE / DELETE</li><li><strong>提取原则</strong>：仅抽取业务关键字段</li></ul><h2 id="四、elasticsearch-分页机制" tabindex="-1">四、Elasticsearch 分页机制 <a class="header-anchor" href="#四、elasticsearch-分页机制" aria-label="Permalink to &quot;四、Elasticsearch 分页机制&quot;">​</a></h2><h3 id="_4-1-from-size-传统分页" tabindex="-1">4.1 from + size（传统分页） <a class="header-anchor" href="#_4-1-from-size-传统分页" aria-label="Permalink to &quot;4.1 from + size（传统分页）&quot;">​</a></h3><ul><li>存在硬性限制：<code>index.max_result_window = 10000</code></li><li>深分页会导致性能灾难</li></ul><h3 id="_4-2-scroll" tabindex="-1">4.2 Scroll <a class="header-anchor" href="#_4-2-scroll" aria-label="Permalink to &quot;4.2 Scroll&quot;">​</a></h3><ul><li>适用场景：离线批量导出</li><li>限制：不支持跳页</li></ul><h3 id="_4-3-search-after-当前推荐方案" tabindex="-1">4.3 Search After（当前推荐方案） <a class="header-anchor" href="#_4-3-search-after-当前推荐方案" aria-label="Permalink to &quot;4.3 Search After（当前推荐方案）&quot;">​</a></h3><ul><li>基于上一页最后一条记录的 <strong>sort 值</strong> 进行下一页查询</li><li>优点：无深分页性能问题</li></ul><h3 id="_4-4-前端分页深度校验-防护措施" tabindex="-1">4.4 前端分页深度校验（防护措施） <a class="header-anchor" href="#_4-4-前端分页深度校验-防护措施" aria-label="Permalink to &quot;4.4 前端分页深度校验（防护措施）&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (requestParam.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCurrent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> requestParam.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ClientException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(BaseErrorCode.SEARCH_AMOUNT_EXCEEDS_LIMIT);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="五、es-分页结果修正" tabindex="-1">五、ES 分页结果修正 <a class="header-anchor" href="#五、es-分页结果修正" aria-label="Permalink to &quot;五、ES 分页结果修正&quot;">​</a></h2><p><strong>原问题</strong>：</p><ul><li>total 使用当前页记录数</li><li>pages 使用错误总数计算</li></ul><p><strong>修正后代码</strong>：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pageResult.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setRecords</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(couponTemplatePageQueryRespDTOS);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pageResult.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTotal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(docSearchHits.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTotalHits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pageResult.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setPages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(docSearchHits.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTotalHits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> requestParam.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span></code></pre></div><h2 id="六、mybatis-并发库存扣减" tabindex="-1">六、MyBatis 并发库存扣减 <a class="header-anchor" href="#六、mybatis-并发库存扣减" aria-label="Permalink to &quot;六、MyBatis 并发库存扣减&quot;">​</a></h2><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> decrementCouponTemplateStock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shopNumber&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) Long shopNumber,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;couponTemplateId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) Long couponTemplateId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;decrementStock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) Long decrementStock);</span></span></code></pre></div><ul><li>依赖：<strong>数据库原子性</strong></li><li>目的：防止超卖</li></ul><h2 id="七、日志系统-logrecord" tabindex="-1">七、日志系统（LogRecord） <a class="header-anchor" href="#七、日志系统-logrecord" aria-label="Permalink to &quot;七、日志系统（LogRecord）&quot;">​</a></h2><h3 id="_7-1-核心注解字段" tabindex="-1">7.1 核心注解字段 <a class="header-anchor" href="#_7-1-核心注解字段" aria-label="Permalink to &quot;7.1 核心注解字段&quot;">​</a></h3><table tabindex="0"><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>success</td><td>成功日志模板</td></tr><tr><td>fail</td><td>失败日志模板</td></tr><tr><td>operator</td><td>操作人</td></tr><tr><td>type</td><td>日志大类</td></tr><tr><td>subType</td><td>日志子类</td></tr><tr><td>bizNo</td><td>业务主键</td></tr><tr><td>condition</td><td>记录条件（SpEL）</td></tr></tbody></table><h3 id="_7-2-底层实现机制" tabindex="-1">7.2 底层实现机制 <a class="header-anchor" href="#_7-2-底层实现机制" aria-label="Permalink to &quot;7.2 底层实现机制&quot;">​</a></h3><ul><li>AOP 切面拦截</li><li>SpEL 表达式解析</li><li>日志上下文使用 <strong>ThreadLocal</strong> 存储</li></ul><h2 id="八、雪花-id-与日志上下文配合" tabindex="-1">八、雪花 ID 与日志上下文配合 <a class="header-anchor" href="#八、雪花-id-与日志上下文配合" aria-label="Permalink to &quot;八、雪花 ID 与日志上下文配合&quot;">​</a></h2><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">couponTemplateMapper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">insert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(couponTemplateDO);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LogRecordContext.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">putVariable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bizNo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, couponTemplateDO.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div><ul><li>MyBatis-Plus 默认策略：<code>IdType.ASSIGN_ID</code></li><li>插入成功后<strong>自动回填</strong>主键</li></ul><h2 id="九、bean-转-map-常用工具" tabindex="-1">九、Bean 转 Map（常用工具） <a class="header-anchor" href="#九、bean-转-map-常用工具" aria-label="Permalink to &quot;九、Bean 转 Map（常用工具）&quot;">​</a></h2><ul><li>工具：<strong>Hutool</strong></li><li>特性：基于反射，null 值转为<strong>空字符串</strong></li><li>典型用途：构造 Redis Hash 数据结构</li></ul><h2 id="十、redis-hash-库存模型" tabindex="-1">十、Redis Hash 库存模型 <a class="header-anchor" href="#十、redis-hash-库存模型" aria-label="Permalink to &quot;十、Redis Hash 库存模型&quot;">​</a></h2><p><strong>Key 格式</strong>：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>merchant:admin:coupon:template:{id}</span></span></code></pre></div><ul><li>数据结构：<strong>Hash</strong></li><li>库存字段原子操作：</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stringRedisTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opsForHash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">increment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, number);</span></span></code></pre></div><h2 id="十一、线程池策略-适用于可重算任务" tabindex="-1">十一、线程池策略（适用于可重算任务） <a class="header-anchor" href="#十一、线程池策略-适用于可重算任务" aria-label="Permalink to &quot;十一、线程池策略（适用于可重算任务）&quot;">​</a></h2><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ThreadPoolExecutor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cpu,                    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// core</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cpu </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,               </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// max</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    60L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// keep-alive</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    TimeUnit.SECONDS,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SynchronousQueue&lt;&gt;(),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ThreadPoolExecutor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DiscardPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 拒绝策略：直接丢弃</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><ul><li>适用场景：任务可重算，丢弃无重大影响</li></ul><h2 id="十二、fastjson-fastjson2-兼容性注意" tabindex="-1">十二、Fastjson / Fastjson2 兼容性注意 <a class="header-anchor" href="#十二、fastjson-fastjson2-兼容性注意" aria-label="Permalink to &quot;十二、Fastjson / Fastjson2 兼容性注意&quot;">​</a></h2><ul><li>包路径完全不同</li><li>API 存在差异</li><li><strong>不可混用</strong>（容易出现序列化/反序列化异常）</li></ul><h2 id="十三、日志服务扩展能力" tabindex="-1">十三、日志服务扩展能力 <a class="header-anchor" href="#十三、日志服务扩展能力" aria-label="Permalink to &quot;十三、日志服务扩展能力&quot;">​</a></h2><ul><li>支持复杂条件查询</li><li>支持分页 + 排序</li><li>支持批量写入（Bulk / Batch）</li><li>支持异步合并提交</li></ul><h2 id="十四、状态枚举-典型用法" tabindex="-1">十四、状态枚举（典型用法） <a class="header-anchor" href="#十四、状态枚举-典型用法" aria-label="Permalink to &quot;十四、状态枚举（典型用法）&quot;">​</a></h2><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ACTIVE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 进行中</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ENDED</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 已结束</span></span></code></pre></div><p>用于标识优惠券等业务实体的生命周期状态</p><hr>`,51))])}const F=t(k,[["render",d]]);export{b as __pageData,F as default};
