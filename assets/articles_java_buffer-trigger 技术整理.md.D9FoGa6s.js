import{_ as n,C as t,c as l,o as e,j as i,G as h,ai as k,a as p}from"./chunks/framework.6CbiclxB.js";const F=JSON.parse('{"title":"buffer-trigger 技术整理","description":"","frontmatter":{"title":"buffer-trigger 技术整理"},"headers":[],"relativePath":"articles/java/buffer-trigger 技术整理.md","filePath":"articles/java/buffer-trigger 技术整理.md","lastUpdated":1768136749000}'),r={name:"articles/java/buffer-trigger 技术整理.md"};function d(E,s,g,c,o,y){const a=t("ArticleMetadata");return e(),l("div",null,[s[0]||(s[0]=i("h1",{id:"buffer-trigger-技术整理",tabindex:"-1"},[p("buffer-trigger 技术整理 "),i("a",{class:"header-anchor",href:"#buffer-trigger-技术整理","aria-label":'Permalink to "buffer-trigger 技术整理"'},"​")],-1)),h(a),s[1]||(s[1]=k(`<p><strong>项目定位</strong><br> buffer-trigger 是一个<strong>内存缓冲 + 条件触发批量消费</strong>的通用框架。<br> 核心目标：减少高频 IO、数据库写入、MQ 投递次数，提升系统吞吐量与稳定性。</p><p><strong>核心思想</strong>（三句话概括）</p><ol><li>先写内存（快速响应）</li><li>按条件成批消费（批量优化）</li><li>消费策略可切换（场景适配）</li></ol><h2 id="一、顶层开放接口-buffertrigger" tabindex="-1">一、顶层开放接口（BufferTrigger） <a class="header-anchor" href="#一、顶层开放接口-buffertrigger" aria-label="Permalink to &quot;一、顶层开放接口（BufferTrigger）&quot;">​</a></h2><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BufferTrigger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AutoCloseable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 生产：写入缓冲区</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> enqueue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(E </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">element</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 手动强制触发一次消费</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> manuallyDoTrigger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 当前待消费数据量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    long</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getPendingChanges</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 关闭并清空剩余数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 构建器入口 - 轻量非阻塞路线</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; GenericSimpleBufferTriggerBuilder&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">simple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GenericSimpleBufferTriggerBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SimpleBufferTrigger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 构建器入口 - 生产级阻塞路线</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; GenericBatchConsumerTriggerBuilder&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">batchBlocking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GenericBatchConsumerTriggerBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(BatchConsumeBlockingQueueTrigger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="二、两条核心实现路径对比" tabindex="-1">二、两条核心实现路径对比 <a class="header-anchor" href="#二、两条核心实现路径对比" aria-label="Permalink to &quot;二、两条核心实现路径对比&quot;">​</a></h2><table tabindex="0"><thead><tr><th>特性</th><th>simple</th><th>batchBlocking（生产推荐）</th></tr></thead><tbody><tr><td>消费方式</td><td>非阻塞</td><td>阻塞式消费</td></tr><tr><td>并发消费</td><td>允许并发多次消费</td><td>严格单消费者（顺序保证）</td></tr><tr><td>流量控制</td><td>无</td><td>有（队列满则生产者阻塞）</td></tr><tr><td>顺序性保证</td><td>不保证</td><td>强顺序保证</td></tr><tr><td>适用场景</td><td>轻量、低并发、顺序不敏感</td><td>高并发、大数据量、顺序/限流敏感</td></tr><tr><td>底层数据结构</td><td>自定义实现</td><td>LinkedBlockingQueue</td></tr><tr><td>生产者行为</td><td>非阻塞</td><td>队列满时阻塞</td></tr><tr><td>默认推荐</td><td>仅作工具</td><td>生产级首选</td></tr></tbody></table><p><strong>结论</strong></p><ul><li><strong>batchBlocking 是武器</strong>，适用于绝大多数线上场景</li><li><strong>simple 是工具</strong>，仅在明确轻量需求时使用</li></ul><h2 id="三、batchblocking-核心实现要点" tabindex="-1">三、batchBlocking 核心实现要点 <a class="header-anchor" href="#三、batchblocking-核心实现要点" aria-label="Permalink to &quot;三、batchBlocking 核心实现要点&quot;">​</a></h2><h3 id="_3-1-构造与调度" tabindex="-1">3.1 构造与调度 <a class="header-anchor" href="#_3-1-构造与调度" aria-label="Permalink to &quot;3.1 构造与调度&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 使用有界阻塞队列</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.queue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LinkedBlockingQueue&lt;&gt;(Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bufferSize, batchSize));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 单线程调度器（默认内部创建）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.scheduledExecutorService </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.scheduledExecutorService </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder.scheduledExecutorService </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Executors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newScheduledThreadPool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, daemonThreadFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 动态延迟定时任务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MoreFutures.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">scheduleWithDynamicDelay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    scheduledExecutorService,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    linger,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doBatchConsumer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TRIGGER_TYPE.LINGER)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="_3-2-触发条件-任一满足即消费" tabindex="-1">3.2 触发条件（任一满足即消费） <a class="header-anchor" href="#_3-2-触发条件-任一满足即消费" aria-label="Permalink to &quot;3.2 触发条件（任一满足即消费）&quot;">​</a></h3><ol><li>队列元素数量 ≥ batchSize</li><li>自上次消费后等待时间 ≥ linger</li><li>调用 manuallyDoTrigger()</li></ol><h3 id="_3-3-阻塞机制来源" tabindex="-1">3.3 阻塞机制来源 <a class="header-anchor" href="#_3-3-阻塞机制来源" aria-label="Permalink to &quot;3.3 阻塞机制来源&quot;">​</a></h3><ul><li>ReentrantLock + 两个 Condition</li><li>notFull：队列满时生产者 await</li><li>notEmpty：队列空时消费者 await</li></ul><h3 id="_3-4-消费执行与异常处理" tabindex="-1">3.4 消费执行与异常处理 <a class="header-anchor" href="#_3-4-消费执行与异常处理" aria-label="Permalink to &quot;3.4 消费执行与异常处理&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">consumer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">accept</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(batchData);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 批量消费回调</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 异常处理链路</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (exceptionHandler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    exceptionHandler.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e, batchData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 默认仅记录日志，不抛出</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Batch consume failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-5-关闭语义-完整可靠" tabindex="-1">3.5 关闭语义（完整可靠） <a class="header-anchor" href="#_3-5-关闭语义-完整可靠" aria-label="Permalink to &quot;3.5 关闭语义（完整可靠）&quot;">​</a></h3><ul><li>取消所有定时任务</li><li>强制 flush 剩余所有数据（最后一波消费）</li><li>如果内部创建线程池，则进行 shutdown</li></ul><h3 id="_3-6-关键工具方法" tabindex="-1">3.6 关键工具方法 <a class="header-anchor" href="#_3-6-关键工具方法" aria-label="Permalink to &quot;3.6 关键工具方法&quot;">​</a></h3><ul><li><code>Uninterruptibles.putUninterruptibly</code>：忽略中断，直到成功入队（关键数据路径必用）</li><li><code>MoreFutures.scheduleWithDynamicDelay</code>：支持动态延迟的定时调度</li></ul><h2 id="四、总结一句话" tabindex="-1">四、总结一句话 <a class="header-anchor" href="#四、总结一句话" aria-label="Permalink to &quot;四、总结一句话&quot;">​</a></h2><p><strong>buffer-trigger = 内存缓冲 + 多维度批量触发 + 可切换的消费策略</strong><br><strong>simple 适合实验和轻量场景，batchBlocking 才是线上真正能扛事的核心武器。</strong></p>`,24))])}const b=n(r,[["render",d]]);export{F as __pageData,b as default};
